# Janet Web Server Makefile

# Variables
JANET = janet
JPM = jpm
MAIN = main.janet
SERVER_DIR = server
PUBLIC_DIR = public
TEST_DIR = test

# Default target
.PHONY: all
all: deps build

# Install dependencies
.PHONY: deps
deps:
	@echo "ğŸ“¦ Installing dependencies..."
	$(JPM) install

# Development dependencies
.PHONY: dev-deps
dev-deps:
	@echo "ğŸ”§ Installing dev dependencies..."
	$(JPM) install judge

# Run the server
.PHONY: start
start:
	@echo "ğŸš€ Starting Janet Web Server..."
	$(JANET) $(MAIN)

# Run in development mode with auto-reload
.PHONY: dev
dev:
	@echo "ğŸ”„ Starting development server..."
	$(JANET) -l $(MAIN)

# Build the project
.PHONY: build
build:
	@echo "ğŸ—ï¸ Building project..."
	$(JPM) build

# Clean build artifacts
.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	$(JPM) clean
	rm -rf build/

# Run tests
.PHONY: test
test:
	@echo "ğŸ§ª Running tests..."
	$(JANET) $(TEST_DIR)/run-tests.janet

# Install the executable
.PHONY: install
install: build
	@echo "ğŸ“¥ Installing janet-web-server..."
	$(JPM) install

# Uninstall the executable
.PHONY: uninstall
uninstall:
	@echo "ğŸ—‘ï¸ Uninstalling janet-web-server..."
	$(JPM) uninstall

# Create public directory if it doesn't exist
.PHONY: setup
setup:
	@echo "âš™ï¸ Setting up project structure..."
	mkdir -p $(PUBLIC_DIR)
	mkdir -p $(TEST_DIR)
	@if [ ! -f $(PUBLIC_DIR)/index.html ]; then \
		echo "ğŸ“„ Creating sample index.html..."; \
		echo '<!DOCTYPE html><html><head><title>Janet Web Server</title></head><body><h1>ğŸš€ Janet Web Server Running!</h1></body></html>' > $(PUBLIC_DIR)/index.html; \
	fi

# Check Janet and JPM installation
.PHONY: check
check:
	@echo "ğŸ” Checking Janet installation..."
	@$(JANET) -v || (echo "âŒ Janet not found. Please install Janet first." && exit 1)
	@$(JPM) --version || (echo "âŒ JPM not found. Please install JPM first." && exit 1)
	@echo "âœ… Janet environment is ready!"

# Show help
.PHONY: help
help:
	@echo "ğŸ“š Janet Web Server - Available Commands:"
	@echo ""
	@echo "  ğŸ—ï¸  Build Commands:"
	@echo "    deps        Install dependencies"
	@echo "    dev-deps    Install development dependencies"
	@echo "    build       Build the project"
	@echo "    clean       Clean build artifacts"
	@echo "    install     Install the executable"
	@echo "    uninstall   Uninstall the executable"
	@echo ""
	@echo "  ğŸš€ Development Commands:"
	@echo "    start       Start the web server"
	@echo "    dev         Start in development mode"
	@echo "    test        Run tests"
	@echo ""
	@echo "  âš™ï¸  Setup Commands:"
	@echo "    setup       Create project structure"
	@echo "    check       Check Janet installation"
	@echo "    help        Show this help message"
	@echo ""
	@echo "  ğŸ“– Example Usage:"
	@echo "    make check    # Check if Janet is installed"
	@echo "    make setup    # Setup project structure"
	@echo "    make deps     # Install dependencies"
	@echo "    make start    # Start the server"

# Default help when no target is specified
.DEFAULT_GOAL := help